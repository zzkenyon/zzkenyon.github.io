<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>MQ-为什么用和什么时候用（转） | 黑风雅过吟</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/zzkenyon.github.io/css/style.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/zzkenyon.github.io/css/highlight.css?v=2.0.3"><link rel="Shortcut Icon" href="/zzkenyon.github.io/favicon.ico"><link rel="bookmark" href="/zzkenyon.github.io/favicon.ico"><link rel="apple-touch-icon" href="/zzkenyon.github.io/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/zzkenyon.github.io/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/zzkenyon.github.io/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">MQ-为什么用和什么时候用（转）</h1><a id="logo" href="/zzkenyon.github.io/.">黑风雅过吟</a><p class="description">不积跬步无以至千里</p></div><div id="nav-menu"><a href="/zzkenyon.github.io/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/zzkenyon.github.io/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/zzkenyon.github.io/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">MQ-为什么用和什么时候用（转）</h1><div class="post-meta"><a href="/zzkenyon.github.io/2019/06/21/MQ-为什么用和什么时候用/#comments" class="comment-count"></a><p><span class="date">Jun 21, 2019</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p><a href="http://mp.weixin.qq.com/s/Brd-j3IcljcY7BV01r712Q" target="_blank" rel="noopener">原文地址</a></p>
<h3 id="1、缘起"><a href="#1、缘起" class="headerlink" title="1、缘起"></a>1、缘起</h3><p>一切脱离业务的架构设计与新技术引入都是耍流氓。</p>
<p>引入一个技术之前，首先应该解答的问题是，这个技术解决什么问题。</p>
<p>就像微服务分层架构之前，应该首先回答，为什么要引入微服务，微服务究竟解决什么问题（详见《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959519&amp;idx=1&amp;sn=065074b135fc9cb243abe897261e1a72&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">互联网架构为什么要做微服务？</a>》）。</p>
<p>最近分享了几篇MQ相关的文章：</p>
<p>《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">MQ如何实现延时消息</a>》</p>
<p>《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">MQ如何实现消息必达</a>》</p>
<p>《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960002&amp;idx=1&amp;sn=c0775231bccf002c3178eabe43f1cdcb&amp;chksm=bd2d071e8a5a8e08c3a5287247ea41dee6b2621e6ffafbf909ec1e8a866b7c816eeeea227246&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">MQ如何实现幂等性</a>》</p>
<p>不少网友询问，究竟什么时候使用MQ，MQ究竟适合什么场景，故有了此文。</p>
<h3 id="2、MQ是干嘛的"><a href="#2、MQ是干嘛的" class="headerlink" title="2、MQ是干嘛的"></a>2、MQ是干嘛的</h3><p>消息总线（Message Queue），后文称MQ，是一种<strong>跨进程</strong>的通信机制，用于上下游传递消息。</p>
<p>在互联网架构中，MQ是一种非常常见的上下游“逻辑解耦+物理解耦”的消息通信服务。</p>
<p>使用了MQ之后，消息发送上游只需要依赖MQ，逻辑上和物理上都不用依赖其他服务。</p>
<h3 id="3、什么时候不使用MQ"><a href="#3、什么时候不使用MQ" class="headerlink" title="3、什么时候不使用MQ"></a>3、什么时候不使用MQ</h3><p>既然MQ是互联网分层架构中的解耦利器，那所有通讯都使用MQ岂不是很好？这是一个严重的误区，调用与被调用的关系，是无法被MQ取代的。</p>
<p>MQ的不足是：</p>
<p>1）系统更复杂，多了一个MQ组件</p>
<p>2）消息传递路径更长，延时会增加</p>
<p>3）消息可靠性和重复性互为矛盾，消息不丢不重难以同时保证</p>
<p>4）上游无法知道下游的执行结果，这一点是很致命的</p>
<p>举个栗子：用户登录场景，登录页面调用passport服务，passport服务的执行结果直接影响登录结果，此处的“登录页面”与“passport服务”就必须使用调用关系，而不能使用MQ通信。</p>
<p>无论如何，记住这个结论：调用方实时依赖执行结果的业务场景，请使用调用，而不是MQ。</p>
<h3 id="4、什么时候使用MQ"><a href="#4、什么时候使用MQ" class="headerlink" title="4、什么时候使用MQ"></a>4、什么时候使用MQ</h3><h4 id="4-1-典型场景一：数据驱动的任务依赖"><a href="#4-1-典型场景一：数据驱动的任务依赖" class="headerlink" title="4.1 典型场景一：数据驱动的任务依赖"></a>4.1 典型场景一：数据驱动的任务依赖</h4><p> 什么是任务依赖，举个栗子，互联网公司经常在凌晨进行一些数据统计任务，这些任务之间有一定的依赖关系，比如：</p>
<p>1）task3需要使用task2的输出作为输入</p>
<p>2）task2需要使用task1的输出作为输入</p>
<p>这样的话，tast1, task2, task3之间就有任务依赖关系，必须task1先执行，再task2执行，载task3执行。</p>
<p>对于这类需求，常见的实现方式是，使用cron人工排执行时间表：</p>
<p>1）task1，0:00执行，经验执行时间为50分钟</p>
<p>2）task2，1:00执行（为task1预留10分钟buffer），经验执行时间也是50分钟</p>
<p>3）task3，2:00执行（为task2预留10分钟buffer）</p>
<p>这种方法的坏处是：</p>
<p>1）如果有一个任务执行时间超过了预留buffer的时间，将会得到错误的结果，因为后置任务不清楚前置任务是否执行成功，此时要手动重跑任务，还有可能要调整排班表</p>
<p>2）总任务的执行时间很长，总是要预留很多buffer，如果前置任务提前完成，后置任务不会提前开始</p>
<p>3）如果一个任务被多个任务依赖，这个任务将会称为关键路径，排班表很难体现依赖关系，容易出错</p>
<p>4）如果有一个任务的执行时间要调整，将会有多个任务的执行时间要调整</p>
<p>无论如何，采用“cron排班表”的方法，各任务耦合，谁用过谁痛谁知道</p>
<p>优化方案是，采用MQ解耦：</p>
<p>1）task1准时开始，结束后发一个“task1 done”的消息</p>
<p>2）task2订阅“task1 done”的消息，收到消息后第一时间启动执行，结束后发一个“task2 done”的消息</p>
<p>3）task3同理</p>
<p>采用MQ的优点是：</p>
<p>1）不需要预留buffer，上游任务执行完，下游任务总会在第一时间被执行</p>
<p>2）依赖多个任务，被多个任务依赖都很好处理，只需要订阅相关消息即可</p>
<p>3）有任务执行时间变化，下游任务都不需要调整执行时间</p>
<p>需要特别说明的是，MQ只用来传递上游任务执行完成的消息，并不用于传递真正的输入输出数据。</p>
<h4 id="4-2-典型场景二：上游不关心执行结果"><a href="#4-2-典型场景二：上游不关心执行结果" class="headerlink" title="4.2 典型场景二：上游不关心执行结果"></a>4.2 典型场景二：上游不关心执行结果</h4><p>上游需要关注执行结果时要用“调用”，上游不关注执行结果时，就可以使用MQ了。</p>
<p>举个栗子，58同城的很多下游需要关注“用户发布帖子”这个事件，比如招聘用户发布帖子后，招聘业务要奖励58豆，房产用户发布帖子后，房产业务要送2个置顶，二手用户发布帖子后，二手业务要修改用户统计数据。</p>
<p>对于这类需求，常见的实现方式是，使用调用关系：</p>
<p>帖子发布服务执行完成之后，调用下游招聘业务、房产业务、二手业务，来完成消息的通知，但事实上，这个通知是否正常正确的执行，帖子发布服务根本不关注。</p>
<p>这种方法的坏处是：</p>
<p>1）帖子发布流程的执行时间增加了</p>
<p>2）下游服务当机，可能导致帖子发布服务受影响，上下游逻辑+物理依赖严重</p>
<p>3）每当增加一个需要知道“帖子发布成功”信息的下游，修改代码的是帖子发布服务，这一点是最恶心的，属于架构设计中典型的依赖倒转，谁用过谁痛谁知道</p>
<p>优化方案是，采用MQ解耦：</p>
<p>1）帖子发布成功后，向MQ发一个消息</p>
<p>2）哪个下游关注“帖子发布成功”的消息，主动去MQ订阅</p>
<p>采用MQ的优点是：</p>
<p>1）上游执行时间短</p>
<p>2）上下游逻辑+物理解耦，除了与MQ有物理连接，模块之间都不相互依赖</p>
<p>3）新增一个下游消息关注方，上游不需要修改任何代码</p>
<h4 id="4-3-典型场景三：上游关注执行结果，但执行时间很长"><a href="#4-3-典型场景三：上游关注执行结果，但执行时间很长" class="headerlink" title="4.3 典型场景三：上游关注执行结果，但执行时间很长"></a>4.3 典型场景三：上游关注执行结果，但执行时间很长</h4><p> 有时候上游需要关注执行结果，但执行结果时间很长（典型的是调用离线处理，或者跨公网调用），也经常使用回调网关+MQ来解耦。</p>
<p>举个栗子，微信支付，跨公网调用微信的接口，执行时间会比较长，但调用方又非常关注执行结果，此时一般怎么玩呢？</p>
<p><img src="https://zzk-markdown.oss-cn-hangzhou.aliyuncs.com/java%E7%BC%96%E7%A8%8B/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="架构图"></p>
<p>一般采用“回调网关+MQ”方案来解耦：</p>
<p>1）调用方直接跨公网调用微信接口</p>
<p>2）微信返回调用成功，此时并不代表返回成功</p>
<p>3）微信执行完成后，回调统一网关</p>
<p>4）网关将返回结果通知MQ</p>
<p>5）请求方收到结果通知</p>
<p>这里需要注意的是，不应该由回调网关来调用上游来通知结果，如果是这样的话，每次新增调用方，回调网关都需要修改代码，仍然会反向依赖，使用回调网关+MQ的方案，新增任何对微信支付的调用，都不需要修改代码啦。</p>
</div><div class="post-copyright"><blockquote><p>原文作者: Zhao Zhengkang</p><p>原文链接: <a href="http://yoursite.com/child/2019/06/21/MQ-为什么用和什么时候用/">http://yoursite.com/child/2019/06/21/MQ-为什么用和什么时候用/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/zzkenyon.github.io/tags/MQ/">MQ</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/zzkenyon.github.io/2019/07/31/数据库-centos安装配置MySql8.0/" class="pre">数据库-centos安装配置MySql8.0</a><a href="/zzkenyon.github.io/2019/05/26/nio-入门篇-应用案例讲解/" class="next">nio-入门篇-应用案例讲解</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、缘起"><span class="toc-text">1、缘起</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、MQ是干嘛的"><span class="toc-text">2、MQ是干嘛的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、什么时候不使用MQ"><span class="toc-text">3、什么时候不使用MQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、什么时候使用MQ"><span class="toc-text">4、什么时候使用MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-典型场景一：数据驱动的任务依赖"><span class="toc-text">4.1 典型场景一：数据驱动的任务依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-典型场景二：上游不关心执行结果"><span class="toc-text">4.2 典型场景二：上游不关心执行结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-典型场景三：上游关注执行结果，但执行时间很长"><span class="toc-text">4.3 典型场景三：上游关注执行结果，但执行时间很长</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/zzkenyon.github.io/2019/11/30/zookeeper-配置和基本操纵/">zookeeper-配置和基本操纵</a></li><li class="post-list-item"><a class="post-list-link" href="/zzkenyon.github.io/2019/11/24/zookeeper-是什么以及能干什么/">zookeeper-是什么以及能干什么</a></li><li class="post-list-item"><a class="post-list-link" href="/zzkenyon.github.io/2019/11/22/分布式-vagrant&virtualBox使用说明/">分布式-vagrant&virtualBox使用说明</a></li><li class="post-list-item"><a class="post-list-link" href="/zzkenyon.github.io/2019/11/06/JVM-元空间/">JVM-元空间</a></li><li class="post-list-item"><a class="post-list-link" href="/zzkenyon.github.io/2019/10/23/git-规范的Commit Message/">git-规范的commit message（转）</a></li><li class="post-list-item"><a class="post-list-link" href="/zzkenyon.github.io/2019/09/02/reids-总结精讲/">redis-总结精讲</a></li><li class="post-list-item"><a class="post-list-link" href="/zzkenyon.github.io/2019/09/02/redis-缓存数据库双写一致性/">redis-缓存数据库双写一致性方案解析</a></li><li class="post-list-item"><a class="post-list-link" href="/zzkenyon.github.io/2019/08/02/redis-键空间通知/">redis-键空间通知</a></li><li class="post-list-item"><a class="post-list-link" href="/zzkenyon.github.io/2019/08/01/redis-数据持久化配置/">redis-数据持久化配置</a></li><li class="post-list-item"><a class="post-list-link" href="/zzkenyon.github.io/2019/07/31/数据库-centos安装配置MySql8.0/">数据库-centos安装配置MySql8.0</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/zzkenyon.github.io/tags/linux命令/" style="font-size: 15px;">linux命令</a> <a href="/zzkenyon.github.io/tags/redis/" style="font-size: 15px;">redis</a> <a href="/zzkenyon.github.io/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/zzkenyon.github.io/tags/并发编程/" style="font-size: 15px;">并发编程</a> <a href="/zzkenyon.github.io/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/zzkenyon.github.io/tags/框架/" style="font-size: 15px;">框架</a> <a href="/zzkenyon.github.io/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/zzkenyon.github.io/tags/nio/" style="font-size: 15px;">nio</a> <a href="/zzkenyon.github.io/tags/MQ/" style="font-size: 15px;">MQ</a> <a href="/zzkenyon.github.io/tags/其他/" style="font-size: 15px;">其他</a> <a href="/zzkenyon.github.io/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/zzkenyon.github.io/tags/SpringBoot/" style="font-size: 15px;">SpringBoot</a> <a href="/zzkenyon.github.io/tags/java/" style="font-size: 15px;">java</a> <a href="/zzkenyon.github.io/tags/分布式/" style="font-size: 15px;">分布式</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/zzkenyon.github.io/archives/2016/05/">五月 2016</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/zzkenyon.github.io/baidusitemap.xml">网站地图</a> |  <a href="/zzkenyon.github.io/atom.xml">订阅本站</a> |  <a href="/zzkenyon.github.io/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/zzkenyon.github.io/." rel="nofollow">Zhao Zhengkang.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/zzkenyon.github.io/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/zzkenyon.github.io/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/zzkenyon.github.io/share/css/share.css"><script type="text/javascript" src="/zzkenyon.github.io/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/zzkenyon.github.io/share/js/qrcode.js" charset="utf-8"></script></body></html>